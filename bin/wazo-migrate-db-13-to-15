#!/bin/sh

MIGRATION_LOG_FILE="/var/log/wazo-database-migration-13-to-15.log"

cluster_exists() {
  # similar check as in the postgresql-client-common package
  local version="$1"
  local name="$2"

  [ -f "/etc/postgresql/$version/$name/postgresql.conf" ]
}

stop_services() {
  echo "Stopping services..."
  systemctl stop cron
  for pid_file in /run/wazo-call-logd.pid /run/wazo-stat.pid; do
    pid=$(cat "$pid_file" 2>/dev/null)
    if [ -n "$pid" ]; then
      kill $pid
    fi
  done
}

migrate_db() {
  echo "Upgrading database cluster..."

  if cluster_exists 15 main; then
    echo "Removing default PostgreSQL 15 cluster..."
    pg_dropcluster --stop 15 main
  fi

  echo "Stopping 13 cluster..."
  systemctl stop postgresql@13-main.service

  echo "Upgrading PostgreSQL 13 cluster to 15..."
  if ! pg_upgradecluster --link -m upgrade -v 15 13 main >>$MIGRATION_LOG_FILE; then
    return 1
  fi

  echo "Removing old PostgreSQL 13 cluster..."
  pg_dropcluster --stop 13 main
}

start_services() {
  echo "Starting services..."
  pg_ctlcluster 15 main start
  systemctl start cron
}

echo "Upgrading PostgreSQL cluster from 13 to 15..."

stop_services
migrate_db
result=$?
start_services

if [ "$result" -eq 0 ]; then
  echo "PostgreSQL cluster upgrade from 13 to 15 successful"
else
  echo "ERROR: upgrade failed, see $MIGRATION_LOG_FILE for more info."
fi

exit "$result"
